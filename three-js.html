<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
<script src="threejs/three.js"></script>
<script src="threejs/TrackballControls.js"></script>
<link rel="import" href="../polymer/polymer.html">

<dom-module id="three-js">
    <template>
      <style>
            :host {
              display: block;
              position: relative;
            }
            canvas {
              position: absolute;
              top: 0;
              right: 0;
              bottom: 0;
              left: 0;
            }
      </style>
      <content></content>
    </template>
    <script>
        Polymer({
          is: 'three-js',
          properties: {
            w: {
                type: String,
                value: "1000"
            },
            h: {
                type: String,
                value: "562"
            }
        },
        ready: function () {
          var renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: true
          });
          Polymer.dom(this.root).appendChild(renderer.domElement);
          this.renderer = renderer;
          renderer.setSize(this.w, this.h);
          //renderer.shadowMapEnabled = true;
          //renderer.shadowMapType = THREE.PCFShadowMap;
          renderer.setClearColor(0, 0);
          this.scene = new THREE.Scene();
          console.log('[%s]: ready', this.localName, this.renderer);
          this.render(); //comment to disable rendering.
        },
        render: function () {
          var self = this;
          window.requestAnimationFrame(function () {
            self.render();
          });
          if (this.camera) {
            //console.log(this.scene);
            this.controls.update();
            this.controls.handleResize(); //FIXME
            this.renderer.render(this.scene, this.camera);
          } else
            console.log('no camera');
        },
        addToScene: function (object) {
          if (object.type == "PerspectiveCamera"){
            this.camera = object;
            this.controls = new THREE.TrackballControls(this.camera, this.renderer.domElement);
          }
          this.scene.add(object);
        },
        removeFromScene: function (object) {
          this.scene.remove(object);
        },
        getRenderer: function (event) {
          event.detail.renderer = this.renderer;
        },
        listeners: {
          'three-js-get-renderer': 'getRenderer',
        }
    });
    </script>
</dom-module>

<script>
  ThreeJSObjectBehavior = {
    properties: {
      castShadow: {
        type: Boolean,
        value: false,
        notify: true
      },
      object: { observer: 'objectChanged' },
      receiveShadow: {
        type: Boolean,
        value: false,
        notify: true
      },
      rx: {
        type: Number,
        value: 0,
        notify: true
      },
      ry: {
        type: Number,
        value: 0,
        notify: true
      },
      rz: {
        type: Number,
        value: 0,
        notify: true
      },
      x: {
        type: Number,
        value: 0,
        notify: true,
        observer: 'updatePosition'
      },
      y: {
        type: Number,
        value: 0,
        notify: true,
        observer: 'updatePosition'
      },
      z: {
        type: Number,
        value: 0,
        notify: true,
        observer: 'updatePosition'
      }
    },
    setPosition: function (x, y, z) {
      this.x = x;
      this.y = y;
      this.z = z;
    },
    objectChanged: function () {
      this.updatePosition();
    },
    updatePosition: function () {
      if (this.object) {
        this.object.position.set(Number(this.x), Number(this.y), Number(this.z));
        this.object.rotation.set(this.rx * Math.PI / 180, this.ry * Math.PI / 180, this.rz * Math.PI / 180);
        this.object.castShadow = this.castShadow;
        this.object.receiveShadow = this.receiveShadow;
      }
    },
    addToParent3: function () {
      parentNode = Polymer.dom(this).parentNode;
      if (parentNode.addToScene && !this.objectParent) {
        this.objectParent = parentNode;
        parentNode.addToScene(this.object);
      }
    },
    removeFromParent3: function () {
      if (this.objectParent) {
        this.objectParent.removeFromScene(this.object);
        this.objectParent = null;
      }
    },
    detached: function () {
      this.removeFromParent3();
    }
  }
</script>

<dom-module id="three-js-mesh">
  <script>
    Polymer({
      is: 'three-js-mesh',
      behaviors: [ThreeJSObjectBehavior],
      init: function (){
        //TODO: Debounce this.
        if (this.geometry && this.material){
          if(this.objectParent){
            this.removeFromParent3();
          }
          this.object = new THREE.Mesh(this.geometry,this.material);
          this.addToParent3();
        }
      },
      addGeom: function (object){
        this.geometry = object;
        this.init();
      },
      addMaterial: function (object){
        this.material = object;
        this.init();
      },
    });
  </script>
</dom-module>

<dom-module id="three-js-material">
  <script>
    Polymer({
      is: 'three-js-material',
      kinds: {
        basic: 'MeshBasicMaterial',
        lambert: 'MeshLambertMaterial',
        phong: 'MeshPhongMaterial',
        normal: 'MeshNormalMaterial',
        texture: 'texture'
      },
      sides: {
        front: 'FrontSide',
        back: 'BackSide',
        double: 'DoubleSide'
      },
      shadings: {
        flat: 'FlatShading'
      },
      properties: {
        ambient: {
          type: Number,
          value: 0,
          notify: true
        },
        color: {
          type: Number,
          value: 2017398,
          notify: true,
          observer: 'init'
        },
        edgeColor: {
          type: Number,
          value: 0,
          notify: true
        },
        edges: { notify: true },
        kind: { notify: true },
        object: { observer: 'objectChanged' },
        shading: { notify: true },
        shine: {
          type: Number,
          value: 30,
          notify: true
        },
        side: { notify: true },
        specular: {
          type: Number,
          value: 0,
          notify: true
        },
        texture: {
          type: String,
          value: '',
          notify: true
        },
        visible: {
          type: Boolean,
          value: true,
          notify: true
        },
        wireframe: {
          type: Boolean,
          value: false,
          notify: true
        }
      },
      detached: function () {
        this.removeFromParent3();
        //this.removeEdgesFromParent3();
      },
      //this.super();
      init: function () {
        var kind = this.kinds[this.kind] || this.kinds.lambert;
        var side = this.sides[this.side] || this.sides.double;
        var shading = this.shadings[this.shading] || this.shadings.flat;
        switch (kind) {
        case 'texture':
          var texture = THREE.ImageUtils.loadTexture(this.texture);
          var renderer = this.fire('three-js-get-renderer').detail.renderer;
          if (renderer) {
            texture.anisotropy = renderer.getMaxAnisotropy();
          } else {
            console.log('no renderer');
          }
          this.object = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE[side],
            wireframe: this.wireframe
          });
          break;
        default:
          this.object = new THREE[kind]({
            color: this.color,
            side: THREE[side],
            specular: this.specular,
            shininess: this.shine,
            ambient: this.ambient,
            shading: THREE[shading],
            wireframe: this.wireframe,
            visible: this.visible
          });
          break;
        }
        this.object.visible = this.visible;
      },
      ready: function (){
        this.init();
        Polymer.dom(this).parentNode.addMaterial(this.object);
      },
      /*
      createEdges: function (mesh) {
        if (mesh) {
          this.edgesObject = new THREE.EdgesHelper(mesh, this.edgeColor);
          this.addEdgeToParent3();
        }
      },
      addEdgeToParent3: function () {
        if (this.parentNode.parentNode.add3 && !this.edgeParent) {
          this.edgeParent = this.parentNode.parentNode;
          this.edgeParent.scene.add(this.edgesObject);
        }
      },
      removeEdgesFromParent3: function () {
        if (this.edgeParent) {
          this.edgeParent.scene.remove(this.edgesObject);
          this.edgeParent = null;
        }
      },*/
      //console.log('[%s]: REMOVED from threejs-object parent', this.localName + (this.id ? '#' + this.id : ''));
      objectChanged: function () {
        Polymer.dom(this).parentNode.addMaterial(this.object);
      }
    });
  </script>
</dom-module>

<dom-module id="three-js-box">
  <script>
    Polymer({
      is: 'three-js-box',
      properties: {
        d: {
          type: Number,
          value: 100,
          notify: true,
          observer: 'newGeo'
        },
        extent: {
          type: Number,
          value: 0,
          notify: true,
          observer: 'extentChanged'
        },
        h: {
          type: Number,
          value: 100,
          notify: true,
          observer: 'newGeo'
        },
        w: {
          type: Number,
          value: 100,
          notify: true,
          observer: 'newGeo'
        }
      },
      ready: function () {
        this.extentChanged();
        this.newGeo();
      },
      extentChanged: function () {
        if (this.extent) {
          this.w = this.h = this.d = this.extent;
        }
      },
      newGeo: function () {
        //console.log("New Geo called");
        this.object = new THREE.BoxGeometry(this.w, this.h, this.d);
        Polymer.dom(this).parentNode.addGeom(this.object);
      }
    });
  </script>
</dom-module>


<dom-module id="three-js-camera">
  <script>
    Polymer({
      is: 'three-js-camera',
      behaviors: [ThreeJSObjectBehavior],
      properties: {
        aspect: { notify: true },
        fov: {
          type: Number,
          value: 45,
          notify: true
        },
        lookAt: {
          type: String,
          value: '',
          notify: true,
        },
        object: { value: null }
      },
      ready: function () {
        this.object = new THREE.PerspectiveCamera(this.fov, this.aspect, 0.1, 10000);
        this.object.lookAt(new THREE.Vector3(0, 0, 0));
        this.addToParent3();
      },
    });
  </script>
</dom-module>
